<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Shake Mix - Seeded Levels</title>
<style>
  body { font-family: system-ui; background:#111; color:#fff; text-align:center; margin:0; padding:20px;}
  h1{margin:5px;} #level{opacity:0.8; margin-bottom:10px;}
  canvas{border:2px solid #444; border-radius:10px; background:#222; image-rendering:pixelated;}
  .row{display:flex; justify-content:center; gap:12px; margin-bottom:12px;}
  button{padding:12px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:bold;}
  .colorBtn{width:80px;color:#000;}
  #checkBtn{background:#00c853;color:#000;} #resetBtn{background:#ff5252;color:#000;}
  #message{margin-top:10px; min-height:24px; font-size:18px;}
</style>
</head>
<body>

<h1>üé® Color Shake Mix</h1>
<div id="level">Level 1</div>

<div class="row">
  <canvas id="targetBox" width="60" height="60"></canvas>
  <canvas id="mixPreview" width="60" height="60"></canvas>
</div>

<canvas id="container" width="240" height="240"></canvas>

<div class="row">
  <button class="colorBtn" id="redBtn" style="background:red">RED</button>
  <button class="colorBtn" id="greenBtn" style="background:lime">GREEN</button>
  <button class="colorBtn" id="blueBtn" style="background:cyan">BLUE</button>
</div>

<div class="row">
  <button id="checkBtn">Check</button>
  <button id="resetBtn">Reset</button>
</div>

<div id="message"></div>

<script>
/* ---------- CONFIG ---------- */
const SIZE = 24;
const PIXELS = SIZE*SIZE;
const SHAKE_THRESHOLD = 28;

/* ---------- STATE ---------- */
let level = 1;
let pixels = Array(PIXELS).fill(null);
let fillIndex = 0;
let holding = null;

/* ---------- CANVAS ---------- */
const container = document.getElementById("container");
const ctx = container.getContext("2d");
const targetBox = document.getElementById("targetBox");
const mixPreview = document.getElementById("mixPreview");
const levelText = document.getElementById("level");
const message = document.getElementById("message");

/* ---------- COLORS ---------- */
const COLORS = { r:{r:255,g:0,b:0}, g:{r:0,g:255,b:0}, b:{r:0,g:0,b:255} };

/* ---------- SEEDED RANDOM ---------- */
function mulberry32(a) {
  return function() {
    var t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

/* ---------- TARGET COLOR ---------- */
function getTarget(level){
  const rand = mulberry32(level); // deterministic per level
  const primaryColors = ['r','g','b'];
  
  // pick primary color
  const primaryIndex = Math.floor(rand()*3);
  const primary = primaryColors[primaryIndex];
  
  // difficulty factor for secondary colors
  const difficulty = Math.min(1, level/50); 
  const secondary1 = (rand()*difficulty*255)|0;
  const secondary2 = (rand()*difficulty*255)|0;

  let target = {r:0,g:0,b:0};
  target[primary] = 255; // primary full
  const others = primaryColors.filter(c=>c!==primary);
  target[others[0]] = secondary1;
  target[others[1]] = secondary2;

  return target;
}

/* ---------- INIT ---------- */
let target = getTarget(level);
fillCanvas(targetBox,target);
updatePreview();
drawContainer();
updateLevel();

/* ---------- HOLD BUTTONS ---------- */
["red","green","blue"].forEach(c=>{
  const btn = document.getElementById(c+"Btn");
  btn.addEventListener("pointerdown",()=>holding=c);
  btn.addEventListener("pointerup",()=>holding=null);
  btn.addEventListener("pointerleave",()=>holding=null);
});

/* ---------- FILL LOOP ---------- */
setInterval(()=>{
  if(!holding || fillIndex>=PIXELS) return;
  pixels[fillIndex++] = holding;
  drawContainer();
  updatePreview();
},40);

/* ---------- SHAKE ---------- */
let lastShake=0;
window.addEventListener("devicemotion", e=>{
  const a = e.accelerationIncludingGravity;
  if(!a) return;
  const force = Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
  const now = Date.now();
  if(force>SHAKE_THRESHOLD && now-lastShake>700){
    mixContainer();
    lastShake=now;
  }
});

/* ---------- BUTTONS ---------- */
document.getElementById("resetBtn").onclick = resetContainer;
document.getElementById("checkBtn").onclick = checkMatch;

/* ---------- FUNCTIONS ---------- */
function fillCanvas(canvas,color){
  const c = canvas.getContext("2d");
  c.fillStyle = `rgb(${color.r},${color.g},${color.b})`;
  c.fillRect(0,0,canvas.width,canvas.height);
}

function drawContainer(){
  const px = container.width/SIZE;
  ctx.clearRect(0,0,container.width,container.height);
  for(let i=0;i<PIXELS;i++){
    const x = (i%SIZE)*px;
    const y = Math.floor(i/SIZE)*px;
    const key = pixels[i];
    ctx.fillStyle = key ? colorKeyToRgb(key) : "#222";
    ctx.fillRect(x,y,px,px);
  }
}

function colorKeyToRgb(key){
  return key==='avg' ? `rgb(${avgMix.r},${avgMix.g},${avgMix.b})` : `rgb(${COLORS[key].r},${COLORS[key].g},${COLORS[key].b})`;
}

function updatePreview(){
  let r=0,g=0,b=0,count=0;
  for(let i=0;i<fillIndex;i++){
    const c = COLORS[pixels[i]];
    r+=c.r; g+=c.g; b+=c.b; count++;
  }
  if(count>0){
    r=Math.round(r/count); g=Math.round(g/count); b=Math.round(b/count);
  } else r=g=b=0;
  fillCanvas(mixPreview,{r,g,b});
}

let avgMix={r:0,g:0,b:0};
function mixContainer(){
  if(fillIndex===0) return;
  let r=0,g=0,b=0;
  for(let i=0;i<fillIndex;i++){
    const c = COLORS[pixels[i]];
    r+=c.r; g+=c.g; b+=c.b;
  }
  avgMix = {r:Math.round(r/fillIndex), g:Math.round(g/fillIndex), b:Math.round(b/fillIndex)};
  for(let i=0;i<fillIndex;i++) pixels[i]='avg';
  drawContainerUniform();
  updatePreviewUniform();
}

function drawContainerUniform(){
  const px = container.width/SIZE;
  ctx.fillStyle = `rgb(${avgMix.r},${avgMix.g},${avgMix.b})`;
  for(let i=0;i<fillIndex;i++){
    const x = (i%SIZE)*px;
    const y = Math.floor(i/SIZE)*px;
    ctx.fillRect(x,y,px,px);
  }
}

function updatePreviewUniform(){
  fillCanvas(mixPreview,avgMix);
}

function resetContainer(){
  pixels = Array(PIXELS).fill(null);
  fillIndex=0;
  drawContainer();
  updatePreview();
  message.textContent="";
}

function checkMatch(){
  const mix = mixPreview.getContext("2d").getImageData(0,0,1,1).data;
  const diff = Math.abs(mix[0]-target.r)+Math.abs(mix[1]-target.g)+Math.abs(mix[2]-target.b);
  const accuracy = 100-(diff/(255*3)*100);
  if(accuracy>=95){
    message.textContent=`üéâ Level Complete! (${accuracy.toFixed(1)}%)`;
    level++;
    target = getTarget(level);
    fillCanvas(targetBox,target);
    resetContainer();
    updateLevel();
  } else {
    message.textContent=`‚ùå ${accuracy.toFixed(1)}% ‚Äî Keep Mixing`;
  }
}

function updateLevel(){ levelText.textContent=`Level ${level}`; }
</script>

</body>
</html>
